name: Build EXE (32-bit)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Python 3.8 (32-bit)
      uses: actions/setup-python@v4
      with:
        python-version: 3.8.7
        architecture: x86

    - name: Upgrade pip
      run: python -m pip install --upgrade pip

    - name: Install dependencies
      run: |
        pip install pyinstaller pillow PyMuPDF

    - name: Get site-packages path
      id: sitepkg
      run: |
        python -c "import site, os; print(os.path.dirname(site.__file__))" > sitepkg_path.txt
        type sitepkg_path.txt
    - name: Read site-packages path
      run: |
        set /p SITEPACKAGES=<sitepkg_path.txt
        echo SITEPACKAGES=%SITEPACKAGES%
        setx SITEPACKAGES "%SITEPACKAGES%"

    - name: Build executable with PyInstaller
      shell: cmd
      run: |
        set SITEPKG_PATH=%SITEPACKAGES%\site-packages\PIL
        if exist "%SITEPKG_PATH%" (
            echo Found PIL at %SITEPKG_PATH%
            pyinstaller --onefile --noconsole ^
              --hidden-import=PIL ^
              --hidden-import=PIL.Image ^
              --hidden-import=PIL.ImageTk ^
              --hidden-import=fitz ^
              --hidden-import=PyMuPDF ^
              --add-data "%SITEPKG_PATH%;PIL" ^
              rename_pdfs_gui9.py
        ) else (
            echo [WARNING] PIL folder not found, skipping add-data.
            pyinstaller --onefile --noconsole ^
              --hidden-import=PIL ^
              --hidden-import=PIL.Image ^
              --hidden-import=PIL.ImageTk ^
              --hidden-import=fitz ^
              --hidden-import=PyMuPDF ^
              rename_pdfs_gui9.py
        )

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: rename_pdfs_gui9-exe
        path: dist/rename_pdfs_gui9.exe
